<!DOCTYPE html>
<html>
  <head>
    <title>Pointum</title>
    <script>
      function rgb(r, g, b) {
        return "rgb(" + r + "," + g + "," + b + ")";
      }

      function drawCircle(x, y, color) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI);
        ctx.fillStyle = rgb(color[0], color[1], color[2]);
        ctx.fill();
      }

      function estimateColor(x, y) {
        var originalSum = crownSum(original, x, y, 0, 3 * radius);
        var outerSum = crownSum(current, x, y, radius, 3 * radius);
        var count = crownCount(current, x, y, 0, radius);
        var color = new Array(3);
        for (var i = 0; i < color.length; ++i) {
          color[i] = Math.round(Math.min(255, Math.max(0,
                (originalSum[i] - outerSum[i]) / count)));
        }
        return color;
      }

      function draw() {
        var x = Math.floor(c.width * Math.random());
        var y = Math.floor(c.height * Math.random());
        var color = estimateColor(x, y);
        crownSet(current, x, y, 0, radius, color);
        drawCircle(x, y, color);
      }

      function canvas2Array() {
        var imgData = ctx.getImageData(0, 0, c.width, c.height).data;
        var imgArray = new Array(c.width);
        for (var i = 0; i < imgArray.length; ++i) {
          imgArray[i] = new Array(c.height);
          for (var j = 0; j < imgArray[i].length; ++j) {
            imgArray[i][j] = new Array(3);
            for (var k = 0; k < 3; ++k) {
              imgArray[i][j][k] = imgData[4 * (i + j * c.width) + k];
            }
          }
        }
        return imgArray;
      }

      function array2Canvas(imgArray) {
        var imgData = ctx.createImageData(c.width, c.height);
        for (var i = 0; i < imgArray.length; ++i) {
          for (var j = 0; j < imgArray[i].length; ++j) {
            for (var k = 0; k < 3; ++k) {
              imgData.data[4 * (i + j * c.width) + k] = imgArray[i][j][k];
            }
            imgData.data[4 * (i + j * c.width) + 3] = 255;
          }
        }
        ctx.putImageData(imgData, 0, 0);
      }

      function imgAverage(image) {
        var average = [0, 0, 0];
        for (var k = 0; k < 3; ++k) {
          for (var i = 0; i < image.length; ++i) {
            for (var j = 0; j < image[i].length; ++j) {
              average[k] += image[i][j][k];
            }
          }
          average[k] /= image.length * image[0].length;
        }
        return average;
      }

      function crownSum(image, x, y, minRadius, maxRadius) {
        var sum = [0, 0, 0];
        for (var i = -maxRadius; i <= maxRadius; ++i) {
          for (var j = -maxRadius; j <= maxRadius; ++j) {
            var xi = x + i;
            var yj = y + j;
            var r = Math.sqrt(Math.pow(i, 2) + Math.pow(j, 2));
            if (xi >= 0 && xi < image.length && yj >= 0 && yj < image[xi].length
                && r >= minRadius && r < maxRadius) {
              for (var k = 0; k < 3; ++k) {
                sum[k] += image[xi][yj][k];
              }
            }
          }
        }
        return sum;
      }

      function crownCount(image, x, y, minRadius, maxRadius) {
        var count = 0;
        for (var i = -maxRadius; i <= maxRadius; ++i) {
          for (var j = -maxRadius; j <= maxRadius; ++j) {
            var xi = x + i;
            var yj = y + j;
            var r = Math.sqrt(Math.pow(i, 2) + Math.pow(j, 2));
            if (xi >= 0 && xi < image.length && yj >= 0 && yj < image[xi].length
                && r >= minRadius && r < maxRadius) {
              ++count;
            }
          }
        }
        return count;
      }

      function crownSet(image, x, y, minRadius, maxRadius, color) {
        for (var i = -maxRadius; i <= maxRadius; ++i) {
          for (var j = -maxRadius; j <= maxRadius; ++j) {
            var xi = x + i;
            var yj = y + j;
            var r = Math.sqrt(Math.pow(i, 2) + Math.pow(j, 2));
            if (xi >= 0 && xi < image.length && yj >= 0 && yj < image[xi].length
                && r >= minRadius && r < maxRadius) {
              image[xi][yj] = color;
            }
          }
        }
      }

      function solidImage(color) {
        var image = new Array(c.width);
        for (var i = 0; i < image.length; ++i) {
          image[i] = new Array(c.height);
          for (var j = 0; j < image[i].length; ++j) {
            image[i][j] = color;
          }
        }
        return image;
      }

      function loadImage() {
        c.width = img.width;
        c.height = img.height;
        ctx.drawImage(img, 0, 0);
        original = canvas2Array();
        current = solidImage(imgAverage(original));
        array2Canvas(current);
        setInterval(draw, 1);
      }

      function loadReader(event) {
        img = new Image();
        img.onload = loadImage;
        img.src = event.target.result;
      }

      function handleImage(e) {
        radius = document.getElementById("radium").value;
        c = document.getElementById("canvium");
        ctx = c.getContext("2d");
        var reader = new FileReader();
        reader.onload = loadReader;
        reader.readAsDataURL(e.target.files[0]);
      }

      function onload() {
        var filium = document.getElementById('filium');
        filium.addEventListener('change', handleImage, false);
      }
    </script>
  </head>
  <body onload="onload()">
    <h1>Pointum</h1>
    <div>
      <label for="radium">Radius: </label>
      <input type="number" id="radium" value="10"/>
    </div>
    <div>
      <input type="file" id="filium"/>
    </div>
    <div>
      <canvas id="canvium" width="500" height="500" style="border:1px solid #000000;"></canvas>
    </div>
  </body>
</html>
