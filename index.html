<!DOCTYPE html>
<html>
  <head>
    <title>Pointum</title>
    <script>
      function getPixel(imgData, index) {
        return imgData.data.slice(index*4, index*4+4) // [R,G,B,A]
      }

      function getPixelXY(imgData, x, y) {
        return getPixel(imgData, y*imgData.width+x);
      }

      function setPixel(imgData, index, r, g, b, a) {
        var i = index*4;
        var d = imgData.data;
        d[i] = r;
        d[i+1] = g;
        d[i+2] = b;
        d[i+3] = a;
      }

      function setPixelXY(imgData, x, y, r, g, b, a) {
        return setPixel(imgData, y*imgData.width+x, r, g, b, a);
      }

      function pickyPicky(form) {
        var num_colors = Number(form.colors.value);
        var radius = Number(form.radius.value);
        var file = form.image.files[0];

        var img = document.getElementById("display");
        img.addEventListener("load", function () {
          var cvs = document.createElement('canvas');
          cvs.width = img.width;
          cvs.height = img.height;
          var ctx = cvs.getContext("2d");
          ctx.drawImage(img, 0, 0, img.width, img.height);
          var idt = ctx.getImageData(0, 0, cvs.width, cvs.height);

          var original = [];
          for (var i = 0; i < cvs.height; ++i) {
            row = [];
            for (var j = 0; j < cvs.width; ++j) {
              row.push(getPixelXY(idt, j, i).slice(0, 3));
            }
            original.push(row);
          }

          var colors = [];
          var average_color = [0, 0, 0];
          for (var row of original) {
            for (var color of row) {
              average_color[0] += color[0];
              average_color[1] += color[1];
              average_color[2] += color[2];
            }
          }
          average_color[0] /= cvs.height * cvs.width;
          average_color[1] /= cvs.height * cvs.width;
          average_color[2] /= cvs.height * cvs.width;
          colors.push(average_color);

          var picked = [];
          for (var i = 0; i < cvs.height; ++i) {
            row = [];
            for (var j = 0; j < cvs.width; ++j) {
              row.push(average_color);
            }
            picked.push(row);
          }

          for (var i = 0; i < cvs.height; ++i) {
            for (var j = 0; j < cvs.width; ++j) {
              setPixelXY(idt, j, i,
                  picked[i][j][0], picked[i][j][1], picked[i][j][2], 255);
            }
          }

          ctx.putImageData(idt, 0, 0);
          img.src = cvs.toDataURL();
        });

        var reader = new FileReader();
        reader.onloadend = function () {
          img.src = reader.result;
        }

        if (file) {
          reader.readAsDataURL(file);
        }
      }
    </script>
  </head>
  <body>
    <h1>Pointum</h1>
    <div>
      <form id="config" action="javascript:pickyPicky(this);">
        <table>
          <tr>
            <td><label for="colors">Number of Colors:</label></td>
            <td><input type="number" id="colors" value=8></td>
          </tr>
          <tr>
            <td><label for="raius">Picky Radius:</label></td>
            <td><input type="number" id="radius" value=16></td>
          </tr>
          <tr>
            <td><label for="image">Reference Image:</label></td>
            <td><input type="file" id="image" accept="image/*"></td>
          </tr>
          <tr>
            <td><input type="submit" value="Picky"></td>
          </tr>
        </table>
      </form>
    </div>
    <div>
      <img src="" id="display" width=500>
    </div>
  </body>
</html>
