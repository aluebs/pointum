<!DOCTYPE html>
<html>
  <head>
    <title>Pointum</title>
    <script>
      function rgb(color) {
        return "rgb(" + color[0] + "," + color[1] + "," + color[2] + ")";
      }

      function drawCircle(x, y, color) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI);
        ctx.fillStyle = rgb(color);
        ctx.fill();
      }

      function estimateColor(x, y) {
        var originalSum = crownSum(original, x, y, 0, 3 * radius);
        var outerSum = crownSum(current, x, y, radius, 3 * radius);
        var count = crownCount(current, x, y, 0, radius);
        var color = new Array(3);
        for (var i = 0; i < color.length; ++i) {
          color[i] = Math.round(Math.min(255, Math.max(0,
                (originalSum[i] - outerSum[i]) / count)));
        }
        return color;
      }

      function drawPoint() {
        radius = document.getElementById("config").value;
        var x = Math.floor(c.width * Math.random());
        var y = Math.floor(c.height * Math.random());
        var color = estimateColor(x, y);
        crownSet(current, x, y, 0, radius, color);
        drawCircle(x, y, color);
      }

      function canvas2Array() {
        var imgData = ctx.getImageData(0, 0, c.width, c.height).data;
        var imgArray = new Array(c.width);
        for (var i = 0; i < imgArray.length; ++i) {
          imgArray[i] = new Array(c.height);
          for (var j = 0; j < imgArray[i].length; ++j) {
            imgArray[i][j] = new Array(3);
            for (var k = 0; k < 3; ++k) {
              imgArray[i][j][k] = imgData[4 * (i + j * c.width) + k];
            }
          }
        }
        return imgArray;
      }

      function array2Canvas(imgArray) {
        var imgData = ctx.createImageData(c.width, c.height);
        for (var i = 0; i < imgArray.length; ++i) {
          for (var j = 0; j < imgArray[i].length; ++j) {
            for (var k = 0; k < 3; ++k) {
              imgData.data[4 * (i + j * c.width) + k] = imgArray[i][j][k];
            }
            imgData.data[4 * (i + j * c.width) + 3] = 255;
          }
        }
        ctx.putImageData(imgData, 0, 0);
      }

      function imgAverage(image) {
        var average = [0, 0, 0];
        for (var k = 0; k < 3; ++k) {
          for (var i = 0; i < image.length; ++i) {
            for (var j = 0; j < image[i].length; ++j) {
              average[k] += image[i][j][k];
            }
          }
          average[k] /= image.length * image[0].length;
        }
        return average;
      }

      function crownSum(image, x, y, minRadius, maxRadius) {
        var sum = [0, 0, 0];
        for (var i = -maxRadius; i <= maxRadius; ++i) {
          for (var j = -maxRadius; j <= maxRadius; ++j) {
            var xi = x + i;
            var yj = y + j;
            var r = Math.sqrt(Math.pow(i, 2) + Math.pow(j, 2));
            if (xi >= 0 && xi < image.length && yj >= 0 && yj < image[xi].length
                && r >= minRadius && r < maxRadius) {
              for (var k = 0; k < 3; ++k) {
                sum[k] += image[xi][yj][k];
              }
            }
          }
        }
        return sum;
      }

      function crownCount(image, x, y, minRadius, maxRadius) {
        var count = 0;
        for (var i = -maxRadius; i <= maxRadius; ++i) {
          for (var j = -maxRadius; j <= maxRadius; ++j) {
            var xi = x + i;
            var yj = y + j;
            var r = Math.sqrt(Math.pow(i, 2) + Math.pow(j, 2));
            if (xi >= 0 && xi < image.length && yj >= 0 && yj < image[xi].length
                && r >= minRadius && r < maxRadius) {
              ++count;
            }
          }
        }
        return count;
      }

      function crownSet(image, x, y, minRadius, maxRadius, color) {
        for (var i = -maxRadius; i <= maxRadius; ++i) {
          for (var j = -maxRadius; j <= maxRadius; ++j) {
            var xi = x + i;
            var yj = y + j;
            var r = Math.sqrt(Math.pow(i, 2) + Math.pow(j, 2));
            if (xi >= 0 && xi < image.length && yj >= 0 && yj < image[xi].length
                && r >= minRadius && r < maxRadius) {
              image[xi][yj] = color;
            }
          }
        }
      }

      function solidImage(color) {
        var image = new Array(c.width);
        for (var i = 0; i < image.length; ++i) {
          image[i] = new Array(c.height);
          for (var j = 0; j < image[i].length; ++j) {
            image[i][j] = color;
          }
        }
        return image;
      }

      function luma(color) {
        return 0.25 * color[0] + 0.65 * color[1] + 0.1 * color[2];
      }

      function blackAndWhite(colorImg) {
        var minl = 255;
        var maxl = 0;
        var baw = new Array(colorImg.length);
        for (var i = 0; i < colorImg.length; ++i) {
          baw[i] = new Array(colorImg[i].length);
          for (var j = 0; j < colorImg[i].length; ++j) {
            baw[i][j] = luma(colorImg[i][j]);
            minl = Math.min(minl, baw[i][j]);
            maxl = Math.max(maxl, baw[i][j]);
          }
        }
        for (var i = 0; i < baw.length; ++i) {
          for (var j = 0; j < baw[i].length; ++j) {
            var l = 255 * (baw[i][j] - minl) / (maxl - minl);
            baw[i][j] = [l, l, l];
          }
        }
        return baw;
      }

      function baw2color(baw) {
        if (baw < 0.1 * 255) {
          return [0, 0, 255];
        } else if (baw > 0.9 * 255) {
          return [255, 255, 0];
        } else {
          while (true) {
            switch (Math.floor(Math.random() * 6)) {
              case 0:
                var x = (baw - 0.25 * 255) / 0.65;
                if (x >= 0 && x <= 255) {
                  return [255, x, 0];
                }
                break;
              case 1:
                var x = (baw - 0.25 * 255) / 0.1;
                if (x >= 0 && x <= 255) {
                  return [255, 0, x];
                }
                break;
              case 2:
                var x = (baw - 0.65 * 255) / 0.25;
                if (x >= 0 && x <= 255) {
                  return [x, 255, 0];
                }
                break;
              case 3:
                var x = (baw - 0.65 * 255) / 0.1;
                if (x >= 0 && x <= 255) {
                  return [0, 255, x];
                }
                break;
              case 4:
                var x = (baw - 0.1 * 255) / 0.25;
                if (x >= 0 && x <= 255) {
                  return [x, 0, 255];
                }
                break;
              case 5:
                var x = (baw - 0.1 * 255) / 0.65;
                if (x >= 0 && x <= 255) {
                  return [0, x, 255];
                }
                break;
            }
          }
        }
      }

      function loadImage() {
        c.width = img.width;
        c.height = img.height;
        ctx.drawImage(img, 0, 0);
        original = canvas2Array();
        if (technique == "pointillism") {
          current = solidImage(imgAverage(original));
          array2Canvas(current);
          setInterval(drawPoint, 1);
        } else if (technique == "fauvism") {
          current = blackAndWhite(original);
          array2Canvas(current);
          for (var i = 0; i < current.length; ++i) {
            for (var j = 0; j < current[i].length; ++j) {
              current[i][j] = baw2color(current[i][j][0]);
            }
          }
          array2Canvas(current);
        }
      }

      function loadReader(event) {
        img = new Image();
        img.onload = loadImage;
        img.src = event.target.result;
      }

      function handleImage(e) {
        ctx = c.getContext("2d");
        var reader = new FileReader();
        reader.onload = loadReader;
        reader.readAsDataURL(e.files[0]);
      }

      function handleDownload(e) {
        e.href = c.toDataURL("image/png");
      }

      function handleTechnique(e) {
        technique = e.value;
        var configlabel = document.getElementById("configlabel");
        var config = document.getElementById("config");
        if (technique == "pointillism") {
          configlabel.innerHTML = "Radius: ";
          config.value = "3";
        } else if (technique == "fauvism") {
          configlabel.innerHTML = "Fauvism: ";
          config.value = "";
        }
      }

      function onload() {
        c = document.getElementById("canvium");
      }
    </script>
  </head>
  <body onload="onload()">
    <h1>Pointum</h1>
    <div>
      <select id="technique" onchange="handleTechnique(this);">
        <option disabled selected value></option>
        <option value="pointillism">Pointillism</option>
        <option value="fauvism">Fauvism</option>
      </select>
    </div>
    <div>
      <label for="config" id="configlabel"></label>
      <input type="text" id="config" value=""/>
    </div>
    <div>
      <input type="file" id="filium" onchange="handleImage(this);"/>
    </div>
    <div>
      <a href="" id="downlium" download="picky.png" onclick="handleDownload(this);">
        <canvas id="canvium" width="500" height="500" style="border:1px solid #000000;"></canvas>
      </a>
    </div>
  </body>
</html>
